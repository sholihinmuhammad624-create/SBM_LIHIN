#include <Wire.h>
#include <RTClib.h>
#include <DHT.h>
#include <LiquidCrystal_I2C.h>
#include <Servo.h>

// ===== PIN =====
#define DHT_PIN 2
#define DHT_TYPE DHT11
#define WATER_PIN A0
#define LIGHT_PIN A1
#define BUTTON_PIN 3
#define BUZZER_PIN 4
#define LED_RED 5
#define LED_GREEN 6
#define SERVO_PIN 9

// ===== KONSTANTA =====
#define WATER_THRESHOLD 160
#define HUMIDITY_RAIN 85
#define SERVO_OPEN 140
#define SERVO_CLOSE 0

RTC_DS3231 rtc;
DHT dht(DHT_PIN, DHT_TYPE);
LiquidCrystal_I2C lcd(0x27, 16, 2);
Servo servoMotor;

// ===== VAR =====
bool servoState = false;        // false = tutup, true = buka
bool lastButton = HIGH;
bool buzzerDone = false;        // agar buzzer hanya 2x

void buzzer2x() {
  for (int i = 0; i < 2; i++) {
    tone(BUZZER_PIN, 1500);
    delay(200);
    noTone(BUZZER_PIN);
    delay(200);
  }
}

void setup() {
  Serial.begin(9600);

  pinMode(BUTTON_PIN, INPUT_PULLUP);
  pinMode(BUZZER_PIN, OUTPUT);
  pinMode(LED_RED, OUTPUT);
  pinMode(LED_GREEN, OUTPUT);

  dht.begin();
  lcd.init();
  lcd.backlight();
  servoMotor.attach(SERVO_PIN);

  rtc.begin();

  lcd.print("Sistem Siap");
  delay(1000);
  lcd.clear();

  servoMotor.write(SERVO_CLOSE);
}

void loop() {
  float suhu = dht.readTemperature();
  float hum = dht.readHumidity();

  int waterVal = analogRead(WATER_PIN);
  int lightVal = analogRead(LIGHT_PIN);
  int lightPct = map(lightVal, 0, 1023, 0, 100);

  DateTime now = rtc.now();

  // ===== KONDISI =====
  bool hujan = (!isnan(hum) && hum >= HUMIDITY_RAIN);
  bool waterLow = (waterVal < WATER_THRESHOLD);
  bool gelap = (lightPct < 10);
  bool jamLima = (now.hour() >= 17);

  bool aman = !(hujan || waterLow || gelap || jamLima);

  // ===== LED =====
  digitalWrite(LED_GREEN, aman);
  digitalWrite(LED_RED, !aman);

  // ===== BUZZER (2x JIKA LED MERAH) =====
  if (!aman && !buzzerDone) {
    buzzer2x();
    buzzerDone = true;
  }
  if (aman) {
    buzzerDone = false;
  }

  // ===== PUSH BUTTON TOGGLE =====
  bool btn = digitalRead(BUTTON_PIN);
  if (btn == LOW && lastButton == HIGH) {
    servoState = !servoState;
    delay(250); // debounce
  }
  lastButton = btn;

  // ===== SERVO =====
  if (gelap || hujan || waterLow || jamLima) {
    servoMotor.write(SERVO_CLOSE);
  } else {
    servoMotor.write(servoState ? SERVO_OPEN : SERVO_CLOSE);
  }

  // ===== STATUS CAHAYA =====
  String kondisi;
  if (hujan) kondisi = "HUJAN";
  else if (gelap) kondisi = "GELAP";
  else if (lightPct <= 50) kondisi = "MENDUNG";
  else kondisi = "CERAH";

  // ===== LCD =====
  lcd.setCursor(0, 0);
  if (isnan(suhu) || isnan(hum)) {
    lcd.print("Sensor Error   ");
  } else {
    lcd.print("T:");
    lcd.print(suhu, 1);
    lcd.print(" H:");
    lcd.print(hum, 0);
    lcd.print("% ");
  }

  lcd.setCursor(0, 1);
  lcd.print(kondisi);
  lcd.print(" ");
  lcd.print(lightPct);
  lcd.print("%   ");

  delay(1000);
}
